# Hario-Core: Modern HAR Parsing

[![PyPI version](https://badge.fury.io/py/hario-core.svg)](https://badge.fury.io/py/hario-core)
[![Build Status](https://github.com/v-pikulev/hario-core/actions/workflows/python-package.yml/badge.svg)](https://github.com/v-pikulev/hario-core/actions/workflows/python-package.yml)
[![Code style: black](https://img.shields.io/badge/code%20style-black-000000.svg)](https://github.com/psf/black)

A modern, extensible, and type-safe library for parsing and processing HAR (HTTP Archive) files. Built with Pydantic, `hario-core` provides a robust foundation for working with HAR data, including built-in support for Chrome DevTools extensions and a powerful mechanism for adding your own extensions.

## Features

-   **Pydantic Models**: Type-safe and validated models for the HAR 1.2 specification.
-   **Extensible by Design**: Easily add support for custom HAR formats (e.g., Safari, Firefox) using a simple registration pattern.
-   **Flexible Enrichment**: Add custom data to your HAR entries using a pluggable enricher pipeline.
-   **Built-in DevTools Support**: Out-of-the-box parsing for HAR files generated by Chrome DevTools.
-   **Protocol-Based Interfaces**: Core logic is built on abstract protocols for maximum flexibility.

## Installation

```bash
pip install hario-core
```

## Basic Usage

Loading a HAR file is simple. `hario-core` automatically detects the format (standard HAR or DevTools) and uses the correct model.

```python
from hario_core import load_har

# Load a HAR file from a path
har_log = load_har("path/to/your/file.har")

# Access validated data
for entry in har_log.entries:
    print(f"{entry.request.method} {entry.request.url} -> {entry.response.status}")

    # If it's a DevTools HAR, you can access specific fields
    if hasattr(entry, "resourceType"):
        print(f"  Resource Type: {entry.resourceType}")
```

## Advanced Usage: Extensibility

`hario-core` is designed to be extended. You can add support for new HAR formats or enrich your data with custom logic.

### 1. Adding Support for a New HAR Format

Let's say you want to add support for Safari HARs, which have a `_webkitTrace` field.

**a) Create your custom model and a detector function:**

```python
# my_safari_extension.py
from typing import Any, Dict
from pydantic import Field
from hario_core.models.har_1_2 import Entry

class SafariEntry(Entry):
    """A Pydantic model for Safari HAR entries."""
    webkit_trace: Dict[str, Any] = Field(alias="_webkitTrace")

def is_safari_entry(entry_json: Dict[str, Any]) -> bool:
    """Detects if a HAR entry is from Safari."""
    return "_webkitTrace" in entry_json
```

**b) Register your model in your application's startup code:**

```python
from hario_core import register_entry_model, load_har
from my_safari_extension import SafariEntry, is_safari_entry

# Register your extension
register_entry_model(detector=is_safari_entry, model=SafariEntry)

# Now, load_har will automatically use SafariEntry for matching files
har_log = load_har("my_safari.har")
```

### 2. Custom Data Enrichment

You can apply a pipeline of custom functions to enrich your data.

```python
from typing import Any, Dict
from hario_core import load_har, apply_enrichment
from hario_core.interfaces import HarEntry

# An enricher is a simple callable
def user_agent_enricher(entry: HarEntry, data: Dict[str, Any]) -> None:
    """Parses the User-Agent header and adds it to the data."""
    for header in entry.request.headers:
        if header.name.lower() == "user-agent":
            # (A real implementation would parse this)
            data["user_agent_details"] = {"raw": header.value}
            break

har_log = load_har("my.har")
first_entry = har_log.entries[0]

# Apply your custom enricher
enriched_data = apply_enrichment(first_entry, enrichers=[user_agent_enricher])

print(enriched_data.get("user_agent_details"))
```

## For Contributors

### Setting up the Development Environment

1.  Clone the repository.
2.  Create and activate a virtual environment (e.g., with `conda` or `venv`):
    ```bash
    conda create --name hario-core python=3.10
    conda activate hario-core
    ```
3.  Install the package in editable mode with development dependencies:
    ```bash
    pip install -e .[dev]
    ```
4.  Install pre-commit hooks:
    ```bash
    pre-commit install
    ```

### Running Tests and Linters

-   **To run tests with coverage:**
    ```bash
    pytest --cov=src/hario_core
    ```
-   **To run `mypy` for type checking:**
    ```bash
    mypy src/hario_core
    ```
-   **To run all pre-commit hooks on all files:**
    ```bash
    pre-commit run --all-files
    ```

## License

This project is licensed under the MIT License. See the [LICENSE](LICENSE) file for details. 